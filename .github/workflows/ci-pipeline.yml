name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '18'

jobs:
  # Stage 1: Fast validation (runs first)
  validate-format:
    name: "ğŸ” Validate Branch & Commit Format"
    runs-on: ubuntu-latest
    outputs:
      skip_pipeline: ${{ steps.detect_semrel.outputs.skip_pipeline }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect semantic-release generated commit
        id: detect_semrel
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%B)"
          subject="$(echo "$msg" | head -n1 | tr -d '\r')"
          body="$(echo "$msg" | tail -n +2)"
          ident="$(git log -1 --pretty=format:%an\|%ae\|%cn\|%ce | tr '[:upper:]' '[:lower:]')"
          echo "Commit subject: $subject"
          if [[ "$subject" =~ ^[0-9]+\.[0-9]+\.[0-9]+([\-\+][0-9A-Za-z\.-]+)?$ ]] \
             && echo "$body" | grep -qi 'automatically generated by python-semantic-release' \
             && echo "$ident" | grep -q 'semantic-release'; then
            echo "skip_pipeline=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ¤– Detected semantic-release commit. Skipping the remainder of the pipeline."
          else
            echo "skip_pipeline=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validate branch and commit format
        run: |
          echo "ğŸ” Starting validation based on semantic release configuration..."
          echo "ğŸ“‹ Checking pyproject.toml for allowed tags..."
          python .github/scripts/validate_format.py
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validation Success
        if: steps.detect_semrel.outputs.skip_pipeline != 'true' && success()
        run: |
          echo "âœ… All validation checks passed!"
          echo "ğŸ‰ Branch name and commit messages follow the required format."

      - name: Skip Notice
        if: steps.detect_semrel.outputs.skip_pipeline == 'true'
        run: |
          echo "â­ï¸  Skipping full CI pipeline for semantic-release commit."

  # Stage 2: Code quality (parallel, after validation)
  lint-python:
    name: "ğŸ Lint Python Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run Python linting
        run: |
          echo "ğŸ” Checking Python code style..."
          echo "ğŸ Running flake8..."
          flake8 backend/ --max-line-length=120 --count --statistics
          echo "ğŸ Running black..."
          black --check backend/ --diff
          echo "ğŸ Running isort..."
          isort --check-only backend/ --diff

  lint-frontend:
    name: "âš›ï¸ Lint Frontend Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend linting
        run: |
          cd frontend
          echo "ğŸ” Checking frontend code style..."
          npm run lint

  # Stage 3: Testing (parallel, after linting)
  test-backend:
    name: "ğŸ§ª Backend Tests"
    runs-on: ubuntu-latest
    needs: [lint-python]  # Wait for Python linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run backend tests
        run: |
          echo "ğŸ§ª Running backend tests..."
          pytest
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb

  test-frontend:
    name: "ğŸ§ª Frontend Tests"
    runs-on: ubuntu-latest
    needs: [lint-frontend]  # Wait for frontend linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend tests
        run: |
          cd frontend
          echo "ğŸ§ª Running frontend tests..."
          npx jest --coverage

  # Stage 4: Semantic Release (only on main branch, not tags)
  semantic-release:
    name: "ğŸš€ Semantic Release"
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      needs.validate-format.outputs.skip_pipeline != 'true'
    permissions:
      contents: write
      id-token: write
    outputs:
      image_tag: ${{ steps.semrel.outputs.image_tag }}
      is_new_release: ${{ steps.semrel.outputs.is_new_release }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Configure Git
        run: |
          git config user.name "semantic-release"
          git config user.email "semantic-release@github-actions"

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SEMREL_GHA_APP_ID }}
          private-key: ${{ secrets.SEMREL_GHA_APP_KEY }}
          owner: bartekmp
          repositories: osmosmjerka
          permission-contents: write
          permission-metadata: read

      - name: Configure Git with App token
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com" > ~/.git-credentials
          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/bartekmp/osmosmjerka.git
          # Verify token is working
          echo "Verifying app token access..."
          git ls-remote --heads origin main > /dev/null && echo "âœ“ Token authentication successful" || echo "âœ— Token authentication failed"

      - name: Run semantic-release version
        id: semrel
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |          
          # Verify token is set
          if [ -z "$GITHUB_TOKEN" ]; then
            echo "::error::GITHUB_TOKEN is not set"
            exit 1
          fi
          echo "GITHUB_TOKEN is set (length: ${#GITHUB_TOKEN})"
          
          # Run semantic-release version --push
          set +e
          python -m semantic_release version --push
          EXIT_CODE=$?
          set -e
          
          echo "Semantic-release exit code: $EXIT_CODE"
          
          # Get short commit SHA for build naming
          SHORT_COMMIT=$(git rev-parse --short HEAD)
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Branch: New version released successfully"
            echo "is_new_release=true" >> "$GITHUB_OUTPUT"
            
            # Extract version from pyproject.toml
            VERSION=$(grep '^version' pyproject.toml | head -1 | awk -F '"' '{print $2}')
            echo "image_tag=$VERSION" >> "$GITHUB_OUTPUT"
            echo "::notice title=New Release::Version ${VERSION} released successfully"
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "Branch: No release necessary or already released"
            echo "is_new_release=false" >> "$GITHUB_OUTPUT"
            echo "image_tag=" >> "$GITHUB_OUTPUT"
            echo "::notice title=No Release::No new release necessary"
          else
            echo "Branch: Unexpected exit code $EXIT_CODE"
            echo "Setting build display name to #${GITHUB_RUN_NUMBER}-${SHORT_COMMIT}"
            echo "::error title=Semantic Release Failed::Semantic-release failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

  semantic-publish:
    name: "ğŸ“¦ Semantic Release Publish"
    runs-on: ubuntu-latest
    needs: semantic-release
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      needs.semantic-release.outputs.is_new_release == 'true'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Configure Git
        run: |
          git config user.name "semantic-release"
          git config user.email "semantic-release@github-actions"

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SEMREL_GHA_APP_ID }}
          private-key: ${{ secrets.SEMREL_GHA_APP_KEY }}
          owner: bartekmp
          repositories: osmosmjerka
          permission-contents: write
          permission-metadata: read

      - name: Configure Git with App token
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com" > ~/.git-credentials
          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/bartekmp/osmosmjerka.git

      - name: Run semantic-release publish
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          python -m semantic_release publish

  # Stage 5: Final summary (always runs)
  pipeline-summary:
    name: "ğŸ“Š Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-python, lint-frontend, test-backend, test-frontend, semantic-release, semantic-publish]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "ğŸ“Š CI Pipeline Execution Summary"
          echo "================================="
          if [[ "${{ needs.validate-format.outputs.skip_pipeline }}" == "true" ]]; then
            echo "â­ï¸  Skipped entire pipeline due to semantic-release commit."
            exit 0
          fi

          echo "ğŸ” Format Validation: ${{ needs.validate-format.result }}"
          echo "ğŸ Python Linting: ${{ needs.lint-python.result }}"
          echo "âš›ï¸ Frontend Linting: ${{ needs.lint-frontend.result }}"
          echo "ğŸ§ª Backend Tests: ${{ needs.test-backend.result }}"
          echo "ğŸ§ª Frontend Tests: ${{ needs.test-frontend.result }}"
          
          # Show semantic release status if it ran
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SEMREL_RESULT="${{ needs.semantic-release.result }}"
            SEMPUB_RESULT="${{ needs.semantic-publish.result }}"
            
            if [[ -n "$SEMREL_RESULT" ]]; then
              if [[ "$SEMREL_RESULT" == "success" ]]; then
                echo "ğŸš€ Semantic Release: $SEMREL_RESULT"
                echo "   - Image Tag: ${{ needs.semantic-release.outputs.image_tag }}"
                echo "   - Is New Release: ${{ needs.semantic-release.outputs.is_new_release }}"
                
                if [[ -n "$SEMPUB_RESULT" ]]; then
                  if [[ "$SEMPUB_RESULT" == "success" ]]; then
                    echo "ğŸ“¦ Semantic Publish: $SEMPUB_RESULT"
                  elif [[ "$SEMPUB_RESULT" == "skipped" ]]; then
                    echo "ğŸ“¦ Semantic Publish: skipped (no new release)"
                  else
                    echo "ğŸ“¦ Semantic Publish: $SEMPUB_RESULT"
                  fi
                fi
              elif [[ "$SEMREL_RESULT" == "skipped" ]]; then
                echo "ğŸš€ Semantic Release: skipped (not main branch or tag)"
              else
                echo "ğŸš€ Semantic Release: $SEMREL_RESULT"
              fi
            fi
          fi

          # Calculate overall status
          CORE_SUCCESS=true
          if [[ "${{ needs.validate-format.result }}" != "success" ]] || \
             [[ "${{ needs.lint-python.result }}" != "success" ]] || \
             [[ "${{ needs.lint-frontend.result }}" != "success" ]] || \
             [[ "${{ needs.test-backend.result }}" != "success" ]] || \
             [[ "${{ needs.test-frontend.result }}" != "success" ]]; then
            CORE_SUCCESS=false
          fi
          
          # Check semantic release status if it ran
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SEMREL_RESULT="${{ needs.semantic-release.result }}"
            if [[ -n "$SEMREL_RESULT" ]] && [[ "$SEMREL_RESULT" != "success" ]] && [[ "$SEMREL_RESULT" != "skipped" ]]; then
              CORE_SUCCESS=false
            fi
          fi
          
          if [[ "$CORE_SUCCESS" == "true" ]]; then
            echo ""
            echo "ğŸ‰ All pipeline stages completed successfully!"
            echo "âœ… Code is ready for deployment!"
          else
            echo ""
            echo "âŒ Some pipeline stages failed"
            echo "Please check the failed jobs above"
            exit 1
          fi