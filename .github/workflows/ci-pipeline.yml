name: CI

on:
  push:
    branches: [ '**' ]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '18'

jobs:
  # Stage 1: Fast validation (runs first)
  validate-format:
    name: "ğŸ” Validate Branch & Commit Format"
    runs-on: ubuntu-latest
    outputs:
      skip_pipeline: ${{ steps.detect_semrel.outputs.skip_pipeline }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Detect semantic-release generated commit
        id: detect_semrel
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          msg="$(git log -1 --pretty=%B)"
          subject="$(echo "$msg" | head -n1 | tr -d '\r')"
          body="$(echo "$msg" | tail -n +2)"
          ident="$(git log -1 --pretty=format:%an\|%ae\|%cn\|%ce | tr '[:upper:]' '[:lower:]')"
          echo "Commit subject: $subject"
          SKIP_PIPELINE=false

          # Skip semantic-release bot commits to avoid CI loops
          if [[ "$subject" =~ ^[0-9]+\.[0-9]+\.[0-9]+([\-\+][0-9A-Za-z\.-]+)?$ ]] \
             && echo "$body" | grep -qi 'automatically generated by python-semantic-release' \
             && echo "$ident" | grep -q 'semantic-release'; then
            SKIP_PIPELINE=true
            echo "ğŸ¤– Detected semantic-release commit. Skipping the remainder of the pipeline."
          fi

          echo "skip_pipeline=$SKIP_PIPELINE" >> "$GITHUB_OUTPUT"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validate branch and commit format
        run: |
          echo "ğŸ” Starting validation based on semantic release configuration..."
          echo "ğŸ“‹ Checking pyproject.toml for allowed tags..."
          python .github/scripts/validate_format.py
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validation Success
        if: steps.detect_semrel.outputs.skip_pipeline != 'true' && success()
        run: |
          echo "âœ… All validation checks passed!"
          echo "ğŸ‰ Branch name and commit messages follow the required format."

      - name: Skip Notice
        if: steps.detect_semrel.outputs.skip_pipeline == 'true'
        run: |
          echo "â­ï¸  Skipping full CI pipeline for semantic-release commit."

  # Stage 2: Code quality (parallel, after validation)
  lint-python:
    name: "ğŸ Lint Python Code"
    runs-on: ubuntu-latest
    needs: validate-format
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run Python linting
        run: |
          echo "ğŸ” Checking Python code style..."
          echo "ğŸ Running flake8..."
          flake8 backend/ --max-line-length=120 --count --statistics
          echo "ğŸ Running black..."
          black --check backend/ --diff
          echo "ğŸ Running isort..."
          isort --check-only backend/ --diff

  lint-frontend:
    name: "âš›ï¸ Lint Frontend Code"
    runs-on: ubuntu-latest
    needs: validate-format
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend linting
        run: |
          cd frontend
          echo "ğŸ” Checking frontend code style..."
          npm run lint

  # Stage 3: Testing (parallel, after linting)
  test-backend:
    name: "ğŸ§ª Backend Tests"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-python]
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run backend tests
        run: |
          echo "ğŸ§ª Running backend tests..."
          pytest
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb

  test-frontend:
    name: "ğŸ§ª Frontend Tests"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-frontend]
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend tests
        run: |
          cd frontend
          echo "ğŸ§ª Running frontend tests..."
          npx jest --coverage

  # Stage 4: Semantic Release (only on main branch, not tags)
  semantic-release:
    name: "ğŸš€ Semantic Release"
    runs-on: ubuntu-latest
    needs: [validate-format, test-backend, test-frontend]
    outputs:
      image_tag: ${{ steps.semrel.outputs.image_tag }}
      skip_image_push: ${{ steps.semrel.outputs.skip_image_push }}
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      needs.validate-format.outputs.skip_pipeline != 'true'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ vars.SEMREL_GHA_APP_ID }}
          private-key: ${{ secrets.SEMREL_GHA_APP_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git with App token
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com" > ~/.git-credentials
          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/bartekmp/osmosmjerka.git
          echo "Verifying app token access..."
          git ls-remote --heads origin main > /dev/null && echo "âœ“ Token authentication successful" || echo "âœ— Token authentication failed"
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Run semantic-release version
        id: semrel
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          set +e
          python -m semantic_release version --push
          EXIT_CODE=$?
          set -e
          
          echo "Semantic-release exit code: $EXIT_CODE"
          SHORT_COMMIT=$(git rev-parse --short HEAD)
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Branch: New version released successfully"
            VERSION=$(grep '^version' pyproject.toml | head -1 | awk -F '"' '{print $2}')
            echo "image_tag=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "skip_image_push=false" >> "$GITHUB_OUTPUT"
            echo "::notice title=New Release::Version ${VERSION} released successfully"
            
            echo "Publishing release..."
            python -m semantic_release publish || {
              echo "::warning title=Publish Failed::Failed to publish release, but version was created"
            }
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "Branch: No release necessary or already released"
            echo "image_tag=v999.0.0-dev" >> "$GITHUB_OUTPUT"
            echo "skip_image_push=true" >> "$GITHUB_OUTPUT"
            echo "::notice title=No Release::No new release necessary"
          else
            echo "Branch: Unexpected exit code $EXIT_CODE"
            echo "Setting build display name to #${GITHUB_RUN_NUMBER}-${SHORT_COMMIT}"
            echo "::error title=Semantic Release Failed::Semantic-release failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

  # Stage 5: Docker Build (no push) â€” all branches
  docker-build:
    name: "ğŸ³ Docker Build (no push)"
    runs-on: ubuntu-latest
    needs: [validate-format, test-backend, test-frontend, semantic-release]
    if: |
      !startsWith(github.ref, 'refs/tags/') &&
      needs.validate-format.outputs.skip_pipeline != 'true' &&
      always() && (needs.semantic-release.result == 'success' || needs.semantic-release.result == 'skipped')
    permissions:
      contents: read
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: osmosmjerka
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Compute dev image tag
        id: devtag
        shell: bash
        run: |
          set -euo pipefail
          
          # On main, use semantic-release version if available; otherwise compute dev tag
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ -n "${{ needs.semantic-release.outputs.image_tag }}" ]]; then
            VERSION="${{ needs.semantic-release.outputs.image_tag }}"
            echo "dev_tag=${VERSION}" >> "$GITHUB_OUTPUT"
            echo "Using semantic-release version: ${VERSION}"
          else
            raw_ref="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
            short_ref="${raw_ref##*/}"
            sanitized="$(echo "$short_ref" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]+/-/g; s/^-+//; s/-+$//; s/-{2,}/-/g')"
            sanitized="${sanitized:0:40}"
            if [[ -z "$sanitized" ]]; then
              sanitized="unknown"
            fi
            echo "dev_tag=v999.0.0-dev-${sanitized}" >> "$GITHUB_OUTPUT"
            echo "Using dev tag: v999.0.0-dev-${sanitized}"
          fi

      - name: Build (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          build-args: |
            VERSION=${{ steps.devtag.outputs.dev_tag }}
          labels: |
            build_id=${{ github.run_id }}
            version=${{ steps.devtag.outputs.dev_tag }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ steps.devtag.outputs.dev_tag }}

  # Stage 6: Docker Push (main only, release only)
  docker-push:
    name: "ğŸ³ Docker Push (GHCR)"
    runs-on: ubuntu-latest
    needs: [validate-format, semantic-release]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      needs.validate-format.outputs.skip_pipeline != 'true' &&
      needs.semantic-release.outputs.skip_image_push != 'true'
    permissions:
      contents: read
      packages: write
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: osmosmjerka
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push (version + latest)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            VERSION=${{ needs.semantic-release.outputs.image_tag }}
          labels: |
            build_id=${{ github.run_id }}
            version=${{ needs.semantic-release.outputs.image_tag }}
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ needs.semantic-release.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:latest

  # Stage 7: Final summary (always runs)
  pipeline-summary:
    name: "ğŸ“Š Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-python, lint-frontend, test-backend, test-frontend, semantic-release, docker-build, docker-push]
    if: always()

    steps:
      - name: Generate summary
        shell: bash
        run: |
          echo "ğŸ“Š CI Pipeline Execution Summary"
          echo "================================="
          if [[ "${{ needs.validate-format.outputs.skip_pipeline }}" == "true" ]]; then
            echo "â­ï¸  Skipped pipeline (semantic-release commit or duplicate push run)."
            exit 0
          fi

          echo "ğŸ” Format Validation: ${{ needs.validate-format.result }}"
          echo "ğŸ Python Linting: ${{ needs.lint-python.result }}"
          echo "âš›ï¸ Frontend Linting: ${{ needs.lint-frontend.result }}"
          echo "ğŸ§ª Backend Tests: ${{ needs.test-backend.result }}"
          echo "ğŸ§ª Frontend Tests: ${{ needs.test-frontend.result }}"
          echo "ğŸ³ Docker Build (no push): ${{ needs.docker-build.result }}"
          echo "ğŸ³ Docker Push (GHCR): ${{ needs.docker-push.result }}"

          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SEMREL_RESULT="${{ needs.semantic-release.result }}"
            if [[ -n "$SEMREL_RESULT" ]]; then
              echo "ğŸš€ Semantic Release: $SEMREL_RESULT"
            fi

            SKIP_PUSH="${{ needs.semantic-release.outputs.skip_image_push || 'true' }}"
            if [[ "$SKIP_PUSH" == "true" ]]; then
              echo "ğŸ³ Image push: skipped"
            else
              IMAGE_TAG="${{ needs.semantic-release.outputs.image_tag }}"
              echo "ğŸ³ Image push: pushed ($IMAGE_TAG, latest)"
            fi
          else
            raw_ref="${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}"
            short_ref="${raw_ref##*/}"
            sanitized="$(echo "$short_ref" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9._-]+/-/g; s/^-+//; s/-+$//; s/-{2,}/-/g')"
            sanitized="${sanitized:0:40}"
            if [[ -z "$sanitized" ]]; then
              sanitized="unknown"
            fi
            echo "ğŸ³ Image tag: v999.0.0-dev-${sanitized}"
            echo "ğŸ³ Image push: skipped (build-only on non-main branch)"
          fi

          CORE_SUCCESS=true
          for result in \
            "${{ needs.validate-format.result }}" \
            "${{ needs.lint-python.result }}" \
            "${{ needs.lint-frontend.result }}" \
            "${{ needs.test-backend.result }}" \
            "${{ needs.test-frontend.result }}" \
            "${{ needs.docker-build.result }}" \
            "${{ needs.semantic-release.result }}" \
            "${{ needs.docker-push.result }}"; do
            if [[ -n "$result" ]] && [[ "$result" != "success" ]] && [[ "$result" != "skipped" ]]; then
              CORE_SUCCESS=false
            fi
          done

          if [[ "$CORE_SUCCESS" == "true" ]]; then
            echo ""
            echo "ğŸ‰ All pipeline stages completed successfully!"
          else
            echo ""
            echo "âŒ Some pipeline stages failed"
            exit 1
          fi
