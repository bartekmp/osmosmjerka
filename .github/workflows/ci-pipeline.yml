name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '18'

jobs:
  # Stage 1: Fast validation (runs first)
  validate-format:
    name: "üîç Validate Branch & Commit Format"
    runs-on: ubuntu-latest
    outputs:
      skip_pipeline: ${{ steps.detect_semrel.outputs.skip_pipeline }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect semantic-release generated commit
        id: detect_semrel
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%B)"
          subject="$(echo "$msg" | head -n1 | tr -d '\r')"
          body="$(echo "$msg" | tail -n +2)"
          ident="$(git log -1 --pretty=format:%an\|%ae\|%cn\|%ce | tr '[:upper:]' '[:lower:]')"
          echo "Commit subject: $subject"
          if [[ "$subject" =~ ^[0-9]+\.[0-9]+\.[0-9]+([\-\+][0-9A-Za-z\.-]+)?$ ]] \
             && echo "$body" | grep -qi 'automatically generated by python-semantic-release' \
             && echo "$ident" | grep -q 'semantic-release'; then
            echo "skip_pipeline=true" >> "$GITHUB_OUTPUT"
            echo "ü§ñ Detected semantic-release commit. Skipping the remainder of the pipeline."
          else
            echo "skip_pipeline=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validate branch and commit format
        run: |
          echo "üîç Starting validation based on semantic release configuration..."
          echo "üìã Checking pyproject.toml for allowed tags..."
          python .github/scripts/validate_format.py
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validation Success
        if: steps.detect_semrel.outputs.skip_pipeline != 'true' && success()
        run: |
          echo "‚úÖ All validation checks passed!"
          echo "üéâ Branch name and commit messages follow the required format."

      - name: Skip Notice
        if: steps.detect_semrel.outputs.skip_pipeline == 'true'
        run: |
          echo "‚è≠Ô∏è  Skipping full CI pipeline for semantic-release commit."

  # Stage 2: Code quality (parallel, after validation)
  lint-python:
    name: "üêç Lint Python Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run Python linting
        run: |
          echo "üîç Checking Python code style..."
          echo "üêç Running flake8..."
          flake8 backend/ --max-line-length=120 --count --statistics
          echo "üêç Running black..."
          black --check backend/ --diff
          echo "üêç Running isort..."
          isort --check-only backend/ --diff

  lint-frontend:
    name: "‚öõÔ∏è Lint Frontend Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend linting
        run: |
          cd frontend
          echo "üîç Checking frontend code style..."
          npm run lint

  # Stage 3: Testing (parallel, after linting)
  test-backend:
    name: "üß™ Backend Tests"
    runs-on: ubuntu-latest
    needs: [lint-python]  # Wait for Python linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    
    services:
      postgres:
        image: postgres:18
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run backend tests
        run: |
          echo "üß™ Running backend tests..."
          pytest
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb

  test-frontend:
    name: "üß™ Frontend Tests"
    runs-on: ubuntu-latest
    needs: [lint-frontend]  # Wait for frontend linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend tests
        run: |
          cd frontend
          echo "üß™ Running frontend tests..."
          npx jest --coverage

  # Stage 4: Semantic Release (only on main branch, not tags)
  semantic-release:
    name: "üöÄ Semantic Release"
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    if: |
      github.ref == 'refs/heads/main' &&
      github.event_name == 'push' &&
      !startsWith(github.ref, 'refs/tags/') &&
      needs.validate-format.outputs.skip_pipeline != 'true'
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Create GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.SEMREL_GHA_APP_ID }}
          private-key: ${{ secrets.SEMREL_GHA_APP_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git with App token
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com" > ~/.git-credentials
          git remote set-url origin https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/bartekmp/osmosmjerka.git
          # Verify token is working
          echo "Verifying app token access..."
          git ls-remote --heads origin main > /dev/null && echo "‚úì Token authentication successful" || echo "‚úó Token authentication failed"
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Run semantic-release version
        id: semrel
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          # Run semantic-release version --push
          set +e
          python -m semantic_release version --push
          EXIT_CODE=$?
          set -e
          
          echo "Semantic-release exit code: $EXIT_CODE"
          
          # Get short commit SHA for build naming
          SHORT_COMMIT=$(git rev-parse --short HEAD)
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "Branch: New version released successfully"
            VERSION=$(grep '^version' pyproject.toml | head -1 | awk -F '"' '{print $2}')
            echo "::notice title=New Release::Version ${VERSION} released successfully"
            
            # Publish the release (create GitHub release)
            echo "Publishing release..."
            python -m semantic_release publish || {
              echo "::warning title=Publish Failed::Failed to publish release, but version was created"
            }
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "Branch: No release necessary or already released"
            echo "::notice title=No Release::No new release necessary"
          else
            echo "Branch: Unexpected exit code $EXIT_CODE"
            echo "Setting build display name to #${GITHUB_RUN_NUMBER}-${SHORT_COMMIT}"
            echo "::error title=Semantic Release Failed::Semantic-release failed with exit code $EXIT_CODE"
            exit $EXIT_CODE
          fi

  # Stage 5: Final summary (always runs)
  pipeline-summary:
    name: "üìä Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-python, lint-frontend, test-backend, test-frontend, semantic-release]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "üìä CI Pipeline Execution Summary"
          echo "================================="
          if [[ "${{ needs.validate-format.outputs.skip_pipeline }}" == "true" ]]; then
            echo "‚è≠Ô∏è  Skipped entire pipeline due to semantic-release commit."
            exit 0
          fi

          echo "üîç Format Validation: ${{ needs.validate-format.result }}"
          echo "üêç Python Linting: ${{ needs.lint-python.result }}"
          echo "‚öõÔ∏è Frontend Linting: ${{ needs.lint-frontend.result }}"
          echo "üß™ Backend Tests: ${{ needs.test-backend.result }}"
          echo "üß™ Frontend Tests: ${{ needs.test-frontend.result }}"
          
          # Show semantic release status if it ran
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SEMREL_RESULT="${{ needs.semantic-release.result }}"
            
            if [[ -n "$SEMREL_RESULT" ]]; then
              if [[ "$SEMREL_RESULT" == "success" ]]; then
                echo "üöÄ Semantic Release: $SEMREL_RESULT"
              elif [[ "$SEMREL_RESULT" == "skipped" ]]; then
                echo "üöÄ Semantic Release: skipped (not main branch or tag)"
              else
                echo "üöÄ Semantic Release: $SEMREL_RESULT"
              fi
            fi
          fi

          # Calculate overall status
          CORE_SUCCESS=true
          if [[ "${{ needs.validate-format.result }}" != "success" ]] || \
             [[ "${{ needs.lint-python.result }}" != "success" ]] || \
             [[ "${{ needs.lint-frontend.result }}" != "success" ]] || \
             [[ "${{ needs.test-backend.result }}" != "success" ]] || \
             [[ "${{ needs.test-frontend.result }}" != "success" ]]; then
            CORE_SUCCESS=false
          fi
          
          # Check semantic release status if it ran
          if [[ "${{ github.ref }}" == "refs/heads/main" ]] && [[ "${{ github.event_name }}" == "push" ]]; then
            SEMREL_RESULT="${{ needs.semantic-release.result }}"
            if [[ -n "$SEMREL_RESULT" ]] && [[ "$SEMREL_RESULT" != "success" ]] && [[ "$SEMREL_RESULT" != "skipped" ]]; then
              CORE_SUCCESS=false
            fi
          fi
          
          if [[ "$CORE_SUCCESS" == "true" ]]; then
            echo ""
            echo "üéâ All pipeline stages completed successfully!"
            echo "‚úÖ Code is ready for deployment!"
          else
            echo ""
            echo "‚ùå Some pipeline stages failed"
            echo "Please check the failed jobs above"
            exit 1
          fi