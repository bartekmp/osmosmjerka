name: CI

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.13'
  NODE_VERSION: '18'

jobs:
  # Stage 1: Fast validation (runs first)
  validate-format:
    name: "ğŸ” Validate Branch & Commit Format"
    runs-on: ubuntu-latest
    outputs:
      skip_pipeline: ${{ steps.detect_semrel.outputs.skip_pipeline }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect semantic-release generated commit
        id: detect_semrel
        shell: bash
        run: |
          msg="$(git log -1 --pretty=%B)"
          subject="$(echo "$msg" | head -n1 | tr -d '\r')"
          body="$(echo "$msg" | tail -n +2)"
          ident="$(git log -1 --pretty=format:%an\|%ae\|%cn\|%ce | tr '[:upper:]' '[:lower:]')"
          echo "Commit subject: $subject"
          if [[ "$subject" =~ ^[0-9]+\.[0-9]+\.[0-9]+([\-\+][0-9A-Za-z\.-]+)?$ ]] \
             && echo "$body" | grep -qi 'automatically generated by python-semantic-release' \
             && echo "$ident" | grep -q 'semantic-release'; then
            echo "skip_pipeline=true" >> "$GITHUB_OUTPUT"
            echo "ğŸ¤– Detected semantic-release commit. Skipping the remainder of the pipeline."
          else
            echo "skip_pipeline=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install toml
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validate branch and commit format
        run: |
          echo "ğŸ” Starting validation based on semantic release configuration..."
          echo "ğŸ“‹ Checking pyproject.toml for allowed tags..."
          python .github/scripts/validate_format.py
        env:
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_HEAD_REF: ${{ github.head_ref }}
          GITHUB_BASE_REF: ${{ github.base_ref }}
          GITHUB_SHA: ${{ github.sha }}
        if: steps.detect_semrel.outputs.skip_pipeline != 'true'

      - name: Validation Success
        if: steps.detect_semrel.outputs.skip_pipeline != 'true' && success()
        run: |
          echo "âœ… All validation checks passed!"
          echo "ğŸ‰ Branch name and commit messages follow the required format."

      - name: Skip Notice
        if: steps.detect_semrel.outputs.skip_pipeline == 'true'
        run: |
          echo "â­ï¸  Skipping full CI pipeline for semantic-release commit."

  # Stage 2: Code quality (parallel, after validation)
  lint-python:
    name: "ğŸ Lint Python Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run Python linting
        run: |
          echo "ğŸ” Checking Python code style..."
          echo "ğŸ Running flake8..."
          flake8 backend/ --max-line-length=120 --count --statistics
          echo "ğŸ Running black..."
          black --check backend/ --diff
          echo "ğŸ Running isort..."
          isort --check-only backend/ --diff

  lint-frontend:
    name: "âš›ï¸ Lint Frontend Code"
    runs-on: ubuntu-latest
    needs: validate-format  # Wait for validation to complete
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend linting
        run: |
          cd frontend
          echo "ğŸ” Checking frontend code style..."
          npm run lint

  # Stage 3: Testing (parallel, after linting)
  test-backend:
    name: "ğŸ§ª Backend Tests"
    runs-on: ubuntu-latest
    needs: [lint-python]  # Wait for Python linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - name: Run backend tests
        run: |
          echo "ğŸ§ª Running backend tests..."
          pytest
        env:
          DATABASE_URL: postgresql://postgres:testpass@localhost:5432/testdb

  test-frontend:
    name: "ğŸ§ª Frontend Tests"
    runs-on: ubuntu-latest
    needs: [lint-frontend]  # Wait for frontend linting
    if: needs.validate-format.outputs.skip_pipeline != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: |
          cd frontend
          npm i

      - name: Run frontend tests
        run: |
          cd frontend
          echo "ğŸ§ª Running frontend tests..."
          npx jest --coverage

  # Stage 4: Final summary (always runs)
  pipeline-summary:
    name: "ğŸ“Š Pipeline Summary"
    runs-on: ubuntu-latest
    needs: [validate-format, lint-python, lint-frontend, test-backend, test-frontend]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "ğŸ“Š CI Pipeline Execution Summary"
          echo "================================="
          if [[ "${{ needs.validate-format.outputs.skip_pipeline }}" == "true" ]]; then
            echo "â­ï¸  Skipped entire pipeline due to semantic-release commit."
            exit 0
          fi

          echo "ğŸ” Format Validation: ${{ needs.validate-format.result }}"
          echo "ğŸ Python Linting: ${{ needs.lint-python.result }}"
          echo "âš›ï¸ Frontend Linting: ${{ needs.lint-frontend.result }}"
          echo "ğŸ§ª Backend Tests: ${{ needs.test-backend.result }}"
          echo "ğŸ§ª Frontend Tests: ${{ needs.test-frontend.result }}"

          # Calculate overall status
          if [[ "${{ needs.validate-format.result }}" == "success" && \
                "${{ needs.lint-python.result }}" == "success" && \
                "${{ needs.lint-frontend.result }}" == "success" && \
                "${{ needs.test-backend.result }}" == "success" && \
                "${{ needs.test-frontend.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ All pipeline stages completed successfully!"
            echo "âœ… Code is ready for deployment!"
          else
            echo ""
            echo "âŒ Some pipeline stages failed"
            echo "Please check the failed jobs above"
            exit 1
          fi