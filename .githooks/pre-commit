#!/usr/bin/env bash

set -Eeuo pipefail

if [[ -n "${SKIP_LOCAL_CI:-}" ]]; then
  printf '\033[1;94m[pre-commit]\033[0m SKIP_LOCAL_CI set; skipping local CI checks.\n'
  exit 0
fi

info() {
  printf '\033[1;94m[pre-commit]\033[0m %s\n' "$1"
}

error() {
  printf '\033[1;31m[pre-commit]\033[0m %s\n' "$1" >&2
}

command_exists() {
  command -v "$1" >/dev/null 2>&1
}

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

# Resolve Python executable
if [[ -n "${PYTHON_BIN:-}" ]]; then
  if !  command_exists "$PYTHON_BIN"; then
    error "Configured PYTHON_BIN='$PYTHON_BIN' is not executable."
    exit 1
  fi
else
  if command_exists python3; then
    PYTHON_BIN=python3
  elif command_exists python; then
    PYTHON_BIN=python
  else
    error "Python 3 is required.  Install project dependencies with 'pip install -e .[dev]'."
    exit 1
  fi
fi

# Validate branch & commit format (mirrors CI validate-format job)
BRANCH_NAME="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo '')"
if [[ -z "$BRANCH_NAME" || "$BRANCH_NAME" == "HEAD" ]]; then
  info "Detached HEAD detected; skipping branch name validation but checking commit format."
  GITHUB_EVENT_NAME=push "$PYTHON_BIN" .github/scripts/validate_format.py
else
  info "Validating branch and commit format..."
  GITHUB_EVENT_NAME=push \
  GITHUB_REF="refs/heads/$BRANCH_NAME" \
  "$PYTHON_BIN" .github/scripts/validate_format.py
fi

# Get staged Python files
STAGED_PYTHON_FILES=($(git diff --cached --name-only --diff-filter=ACM | grep -E '^backend/.*\.py$' || true))

if [[ ${#STAGED_PYTHON_FILES[@]} -gt 0 ]]; then
  info "Running Python linters on ${#STAGED_PYTHON_FILES[@]} staged file(s)..."
  for tool in flake8 black isort; do
    if ! command_exists "$tool"; then
      error "Missing '$tool'. Install with 'pip install -e .[dev]'."
      exit 1
    fi
  done

  flake8 "${STAGED_PYTHON_FILES[@]}" --max-line-length=120 --count --statistics
  black --check "${STAGED_PYTHON_FILES[@]}" --diff
  isort --check-only "${STAGED_PYTHON_FILES[@]}" --diff
else
  info "No staged Python files to lint."
fi

# Get staged frontend files
STAGED_FRONTEND_FILES=($(git diff --cached --name-only --diff-filter=ACM | grep -E '^frontend/' || true))

if [[ ${#STAGED_FRONTEND_FILES[@]} -gt 0 ]]; then
  info "Running frontend lint on ${#STAGED_FRONTEND_FILES[@]} staged file(s)..."
  if ! command_exists npm; then
    error "npm is required. Install Node.js >= 18 and run 'npm install' inside frontend/."
    exit 1
  fi

  # Note: npm run lint typically checks all files.  For staged-only checks, consider using lint-staged
  ( cd frontend && npm run lint )
else
  info "No staged frontend files to lint."
fi

info "All local checks passed. Proceeding with commit."
